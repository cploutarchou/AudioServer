<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <meta name="description" content=""/>
    <meta name="author" content=""/>
    <title>Dashboard - SB Admin</title>
    <link href="/static/css/datatable.css" rel="stylesheet"/>
    <link href="/static/css/bootstrap.css" rel="stylesheet"/>
    <link href="/static/css/styles.css" rel="stylesheet"/>
    <link href="/static/css/custom.css" rel="stylesheet"/>
    <script src="/static/js/all.min.js"></script>
</head>

<body class="sb-nav-fixed">
<nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
    <!-- Navbar Brand-->
    <a class="navbar-brand ps-3" href="{{ url_for('index') }}">{{ data.title }}</a>
</nav>
<div id="loader" class="loader"></div>
<div id="layoutSidenav">
    <div id="layoutSidenav_nav">
        <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
            <div class="sb-sidenav-menu">
                <div class="nav">
                    <div class="sb-sidenav-menu-heading">Menu</div>
                    <a class="nav-link" href="{{ url_for('index') }}">
                        <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                        Dashboard
                    </a>

                    <a class="nav-link" href="{{ url_for('stats') }}">
                        <div class="sb-nav-link-icon"><i class="fas fa-chart-area"></i></div>
                        Stats
                    </a>
                </div>
            </div>
        </nav>
    </div>
    <div id="layoutSidenav_content">
        <main>
            <!-- Modal -->
            <div class="modal fade" id="modal" tabindex="-1" aria-labelledby="exampleModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <table id="upload_id_tbl" class="display" width="100% ">
                                <thead>
                                <tr>
                                    <th>Object ID</th>
                                    <th>File</th>

                                </tr>
                                </thead>
                                <tfoot>
                                <tr>
                                    <th>Object ID</th>
                                    <th>File</th>

                                </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal fade" id="modal_file" tabindex="-1" aria-labelledby="exampleModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title alert alert-secondary text-center" style="width: 100%;"
                                id="modal_file_title"></h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">

                            <table class="table table-hover ">

                                <tbody>
                                <tr>
                                    <td>Title</td>
                                    <td id="object_title"></td>
                                </tr>
                                <tr>
                                    <td>Format type</td>
                                    <td id="object_format"></td>
                                </tr>
                                <tr>
                                    <td>File Size</td>
                                    <td id="object_file_size"></td>
                                </tr>
                                <tr>
                                    <td>Created_at</td>
                                    <td id="object_created"></td>
                                </tr>
                                </tbody>
                            </table>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid px-4">
                <h1 class="mt-4">Dashboard</h1>
                <ol class="breadcrumb mb-4">
                    <li class="breadcrumb-item active">Dashboard</li>
                </ol>
                <div class="row">
                    <div class="col-xl-63 col-md-6">
                        <div class="card bg-primary text-white mb-4">
                            <div class="card-body">Find By Upload ID</div>
                            <div class="card-footer d-flex align-items-center justify-content-between">
                                <form id="find_upload" class="row g-3">
                                    <div class="col-auto">
                                        <label for="upload_id_input" class="visually-hidden">Upload ID</label>
                                        <input type="text" class="form-control" id="upload_id_input" required
                                               placeholder="Upload ID">
                                    </div>
                                    <div class="col-auto">
                                        <button type="submit" class="btn btn-primary mb-3"
                                                style="background-color: #ffffff;color: #0d6efd">Search
                                        </button>
                                    </div>


                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-6 col-md-6">
                        <div class="card bg-warning text-white mb-4">
                            <div class="card-body">Find by Object ID</div>
                            <div class="card-footer d-flex align-items-center justify-content-between">
                                <form id="find_object" class="row g-3">
                                    <div class="col-auto">
                                        <label for="file_object_id" class="visually-hidden">Object ID</label>
                                        <input type="text" class="form-control" id="file_object_id"
                                               placeholder="Object ID" required>
                                    </div>
                                    <div class="col-auto">
                                        <button type="submit" class="btn btn-primary mb-3"
                                                style="background-color: #ffffff;color: #0d6efd">Search
                                        </button>
                                    </div>


                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xl-12">
                        <div class="card mb-12">
                            <div id="wrapper">
                                <div id="page-wrapper">

                                    <div id="upload_id" class="alert alert-success" role="alert" style="display:none">
                                    </div>

                                    <div class="mainbox " id="identitycard" style="margin-top:50px">
                                        <div class="panel panel-info">
                                            <div class="panel-heading text-center">
                                                <h2 class="panel-title">Select file(s) to upload</h2>
                                            </div>
                                            <div class="panel-body">
                                                <div class="container">
                                                    <div class="row">
                                                        <p class="text-center" style="padding: 8px;">File to
                                                            upload {{ data.allowed }}</p>
                                                    </div>
                                                </div>
                                                <div class="row" style="padding: 10px 15px 9px;">
                                                    <form id='file-catcher'>
                                                        <div class=" justify-content-center">
                                                            <input id='file-input' type='file'
                                                                   class="form-control form-control-lg" multiple/>
                                                            <div class="row " style="margin-bottom: 20px;">
                                                                <button type='submit'
                                                                        class="btn btn-lg btn-block btn-success"
                                                                        style="margin-top:50px">
                                                                    Submit
                                                                </button>
                                                            </div>
                                                        </div>

                                                    </form>

                                                    <div id='file-list-display'></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer class="py-4 bg-light mt-auto">
            <div class="container-fluid px-4">
                <div class="d-flex align-items-center justify-content-between small">
                    <div class="text-muted">{{ data.copyright }} <a href="{{ data.my_url }}"
                                                                    target="_blank">{{ data.my_url }}</a></div>
                    <div>
                        <a href="#">Privacy Policy</a>
                        &middot;
                        <a href="#">Terms &amp; Conditions</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>
</div>


<script src="/static/js/bootstrap.bundle.js"></script>
<script src="/static/js/jquery-3.5.1.slim.min.js"></script>
<script src="/static/js/jquery.dataTables.min.js" type="text/javascript"></script>
<script src="/static/js/sweetalert.min.js"></script>
<script src="/static/js/scripts.js"></script>
<script type="text/javascript">
    (function () {
            let mymodal = document.getElementById("modal")
            let file_details_modal = document.getElementById("modal_file")
            let modal = new bootstrap.Modal(mymodal)
            let file_details = new bootstrap.Modal(file_details_modal)
            let generateUUID = () => {
                let d = new Date().getTime();//Timestamp
                let d2 = (performance && performance.now && (performance.now() * 1000)) || 0;//Time in microseconds since page-load or 0 if unsupported
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    let r = Math.random() * 16;//random number between 0 and 16
                    if (d > 0) {//Use timestamp until depleted
                        r = (d + r) % 16 | 0;
                        d = Math.floor(d / 16);
                    } else {//Use microseconds since page-load if supported
                        r = (d2 + r) % 16 | 0;
                        d2 = Math.floor(d2 / 16);
                    }
                    return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
                });
            }

            const job_uuid = generateUUID()

            let loader = (enable) => {
                let loader_div = document.getElementById("loader");
                if (enable === true) {
                    loader_div.style.display = "block"
                } else {
                    loader_div.style.display = "none"
                }

            }

            let fileCatcher = document.getElementById('file-catcher');
            let fileInput = document.getElementById('file-input');
            let fileListDisplay = document.getElementById('file-list-display');

            let fileList = [];
            let renderFileList, sendFile;


            fileCatcher.addEventListener('submit', function (e) {
                e.preventDefault();
                loader(true)
                fileList.forEach(function (file) {
                    sendFile(file)
                });
            });

            fileInput.addEventListener('change', function (e) {
                fileList = [];
                for (let i = 0; i < fileInput.files.length; i++) {
                    fileList.push(fileInput.files[i]);
                }
                renderFileList();
            });

            renderFileList = function () {

                fileListDisplay.innerHTML = '';
                fileList.forEach(function (file, index) {
                    let fileDisplayEl = document.createElement('div');
                    fileDisplayEl.setAttribute("id", "file_id_" + index)
                    fileDisplayEl.setAttribute("class", "alert alert-warning alert-dismissible fade show role='alert'")
                    const btn = "<button type='button' class='btn-close' data-bs-dismiss='alert' aria-label='Close'></button>";
                    fileDisplayEl.innerHTML = (index + 1) + ': ' + file.name + btn;
                    fileListDisplay.appendChild(fileDisplayEl);
                });
            };
            let item_counter = 0;
            let completed = 0
            let failed = 0

            let create_batch = (job_id) => {

                let formData = new FormData();
                let request = new XMLHttpRequest();
                const url = window.location.href + 'create_batch'
                formData.set('uuid', job_id);
                request.open("POST", url);
                request.send(formData);
                request.onload = () => {
                    if (request.status !== 200) { // analyze HTTP status of the response
                        item_counter += 1
                        failed += 1
                    } else {
                        loader(false)
                        swal("Good job!", request.response, "success");
                        let upload_id_div = document.getElementById("upload_id")
                        upload_id_div.innerHTML = 'Upload ID :' +
                            '<a href="#" class="alert-link">' + request.response + '</a>.'
                        upload_id_div.style.display = ""
                    }
                }
            }


            sendFile = function (file) {
                let total_items = fileList.length;
                let formData = new FormData();
                let request = new XMLHttpRequest();
                const url = window.location.href + 'upload'
                formData.set('file', file);
                formData.set('total_items', total_items);
                formData.set('uuid', job_uuid);
                request.open("POST", url, true);
                if (formData) {
                    request.send(formData);
                }
                request.onload = () => {
                    if (request.status !== 200) {
                        item_counter += 1
                        failed += 1
                    } else {
                        let item = document.getElementById("file_id_" + item_counter)
                        item.setAttribute("class", "alert alert-success alert-dismissible fade show role='alert'")
                        item_counter += 1
                        completed += 1
                    }
                    if (failed + completed === total_items) {
                        create_batch(job_uuid)
                    }
                };
            }

            let get_files_by_upload_id = () => {

                const upload_id = document.getElementById("upload_id_input").value
                let request = new XMLHttpRequest();
                {#request.responseType = 'json';#}
                request.open("GET", window.location.href + 'find/' + upload_id);
                request.send();
                request.onload = () => {
                    if (request.status !== 200) { // analyze HTTP status of the response
                        loader(false)
                        swal("Something going wrong!", `No valid Upload ID : ${upload_id}`, "error");
                    } else {
                        loader(false)
                        if (request.response !== "") {
                            const data = JSON.parse(request.response)['data']

                            if (data.length > 0) {
                                $('#upload_id_tbl').DataTable({
                                    data: data,
                                    retrieve: true,
                                    columns: [
                                        {title: "Object ID"},
                                        {title: "File"},
                                    ]
                                });
                            }
                            modal.show()
                        } else {
                            swal("Something going wrong!", `Unable to fetch data for upload id : ${upload_id}`, "error");
                        }
                    }

                }
                request.onerror = () => {
                    loader(false)
                    alert("Request failed");
                    alert("Request failed");
                }
            };

            let find_by_object_id = (file_id) => {

                let request = new XMLHttpRequest();
                const url = window.location.href + 'file/' + file_id
                request.open("GET", url);
                request.send();

                request.onload = () => {
                    if (request.status !== 200) { // analyze HTTP status of the response
                        loader(false)
                        swal("Something going wrong!", `No valid Object ID : ${file_id}`, "error");
                    } else {
                        loader(false)
                        console.log(request.response)
                        if (request.response !== "") {
                            const data = JSON.parse(request.response)
                            console.log(data)
                            document.getElementById("modal_file_title").innerText = "File Details for Object id : " + file_id
                            document.getElementById("object_title").innerText = data['title']
                            document.getElementById("object_format").innerText = data['format_type']
                            document.getElementById("object_file_size").innerText = data['file_size']
                            document.getElementById("object_created").innerText = data['created_at'].toString()
                            file_details.show()
                        } else {
                            swal("Something going wrong!", request.response, "error");
                        }
                    }

                }
            }


            let find_upload = document.getElementById('find_upload');
            let find_object = document.getElementById('find_object');
            find_upload.addEventListener('submit', function (e) {
                e.preventDefault();
                loader(true)
                get_files_by_upload_id()
            });

            find_object.addEventListener('submit', function (e) {
                e.preventDefault();
                loader(true)
                let file = document.getElementById("file_object_id")
                let file_id = file.value
                if (file_id !== "") {
                    find_by_object_id(file_id)
                    file.value = ""
                }
            });
        }
    )();

</script>
</body>
</html>
